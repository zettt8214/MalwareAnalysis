from memfren import *
from virtualbox.library import FileCopyFlag
from lib.config import *
from report import sysmon, procmon
from memfren import volhandel
from memfren.staticscan import *



def run_sample(sample, is_dll = False, dump = False):
    vbox = autovm.Vbox(basename="Project Win7")
    vbox.start(session_type=SessionType.gui)

    vbox.create_guest_session(username="Administrator", password="vv")
    src =  host_path + "\\sample\\" + sample
    dst = vm_path + "\\" + sample
    print(dst)
    vbox.copy_to_vm(source = src, dest = dst, flags=[FileCopyFlag(0)])
    vbox.run_shell_cmd(b"WEVTUtil cl \"Microsoft-Windows-Sysmon/Operational\"")
    if is_dll:
        vbox.run_shell_cmd(b"rundll32.exe " + dst.encode() + b",ThisIsFake" )
    else:
        vbox.run_shell_cmd(b"C:\\startexe.bat " + dst.encode(), timeout = 80000)
    vbox.run_shell_cmd(b"WEVTUtil query-events \"Microsoft-Windows-Sysmon/Operational\" /format:xml /e:sysmonview > C:\\eventlog.xml")

    vbox.copy_from_vm(source=vm_path + "\\eventlog.xml", dest=host_path + "\\result\\eventlog.xml",
                      flags=[FileCopyFlag(0)])
    vbox.copy_from_vm(source=vm_path + "\\log.pml", dest=host_path + "\\result\\log.pml",
                      flags=[FileCopyFlag(0)])
    if dump:
        vbox.dump_memory()
    # recover the VM
    vbox.stop(StopMode.poweroff)
    vbox.restore_snapshot("snap_1")

def generate_report(output, mal_name):

    s = sysmon.SysmonLogParse("result/eventlog.xml")
    s.event_parse()
    s.show(output, mal_name)

    prom = procmon.ProLogParse("result/log.pml")
    prom.generate_xml_from_pml("result/log.xml")
    prom.procmon_log_xml_parse()
    prom.show_log(output,mal_name)

    vl = volhandel.VolatiltyHandler()
    vl.get_image_info("dump/dump.elf")
    vl.show(output)
def static(malware):
    packer_scan(malware)
    static_scan(malware)
    reg_string(malware)

static("./sample/wcry.exe")
run_sample("wcry.exe",dump= True)
generate_report("report.txt", "wcry.exe")

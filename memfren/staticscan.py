from lib.config import *
import subprocess
import re
from collections import namedtuple
from lib.peutils import *
from lib.pefile import *

ASCII_BYTE = rb" !\"#\$%&\'\(\)\*\+,-\./0123456789:;<=>\?@ABCDEFGHIJKLMNOPQRSTUVWXYZ\[\]\^_`abcdefghijklmnopqrstuvwxyz\{\|\}\\\~\t"

String = namedtuple("String", ["s", "offset"])

def packer_scan(malware):
    pe = PE(malware)
    sig = SignatureDatabase(packer_signature)
    matches = sig.match(pe, ep_only=True)

    with open(report, "a+") as f:
        print("Packer Scan result", file=f)
        print("================================", file=f)
        if(matches):
            f.write(matches[0])
        else:
            print("Not detected\r\n", file=f)
        print("\r================================\r\n", file=f)

def static_scan(malware):
    para = "-w " + rule + " " + malware
    cmd = yara + " " + para
    print("[+]Run yara scan:", cmd)
    status, output = subprocess.getstatusoutput(cmd)
    if status == 0:
        with open(report, "a+") as f:
            print("Yara Scan Result with ClamAV", file = f)
            print("================================\r\n", file=f)
            f.write(output)
            print("\r================================\r\n", file=f)



def ascii_strings(buf, n=4):
    reg = rb"([%s]{%d,})" % (ASCII_BYTE, n)
    ascii_re = re.compile(reg)
    for match in ascii_re.finditer(buf):
        yield String(match.group().decode("ascii"), match.start())


def reg_string(malware_plath):
    with open(malware_plath, "rb") as f:
        b = f.read()

    url_regex = "(https?|ftp|file)://[-A-Za-z0-9+&@#/%?=~_|!:,.;]+[-A-Za-z0-9+&@#/%=~_|]"
    urls = []
    apis = []

    for line in ascii_strings(b, n = 6):

        if line.s in windows_api:
            apis.append(line.s)

        else:
            results = re.search(url_regex, line.s)
            if results:
                urls.append(results.group())

    with open(report, "a+") as f:
        print("URLS in Malware: ", file=f)
        print("================================", file=f)

        for url in urls:
            print(url, file = f)
        print("================================\r\n", file=f)

        print("Win_API in Malware: ", file=f)
        print("================================", file=f)
        for api in apis:
            print(api, file = f)
        print("================================\r\n", file=f)
